<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}RFMS Uploader{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <style>
        /* Corporate Fonts */
        body, html {
            font-family: 'Lato', 'Verdana', 'Nevis', sans-serif;
        }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
            font-family: 'Lato', 'Nevis', 'Verdana', sans-serif;
            font-weight: 700;
        }
        .navbar-brand img {
            height: 40px;
        }
        .main-content {
            padding: 2rem 0;
        }
        .card {
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats-card {
            background: linear-gradient(45deg, #01998e, #01b8aa);
            color: white;
        }
        .rfms-online {
            color: #00ff88 !important;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.8), 0 0 20px rgba(0, 255, 136, 0.4);
            animation: pulse-green 1.5s infinite;
            filter: brightness(1.2);
        }
        .rfms-offline {
            color: #dc3545 !important;
        }
        /* Uppercase all text inputs for RFMS compatibility */
        input[type="text"],
        input[type="search"],
        input[type="tel"],
        input[type="email"] {
            text-transform: uppercase;
        }
        /* Ensure uppercase is applied on focus/blur */
        input[type="text"]:focus,
        input[type="search"]:focus,
        input[type="tel"]:focus,
        input[type="email"]:focus {
            text-transform: uppercase;
        }
        @keyframes pulse-green {
            0% { 
                color: #00ff88 !important;
                text-shadow: 0 0 10px rgba(0, 255, 136, 0.8), 0 0 20px rgba(0, 255, 136, 0.4);
                transform: scale(1);
            }
            50% { 
                color: #00ffaa !important;
                text-shadow: 0 0 15px rgba(0, 255, 170, 1), 0 0 30px rgba(0, 255, 170, 0.6);
                transform: scale(1.1);
            }
            100% { 
                color: #00ff88 !important;
                text-shadow: 0 0 10px rgba(0, 255, 136, 0.8), 0 0 20px rgba(0, 255, 136, 0.4);
                transform: scale(1);
            }
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #01998e;
            background-color: #f8f9fa;
        }
        .upload-area.border-primary {
            border-color: #01998e !important;
            background-color: #e6f7f6;
        }
        /* Override Bootstrap primary colors with corporate green */
        .btn-primary, .btn-primary:hover, .btn-primary:focus, .btn-primary:active {
            background-color: #01998e !important;
            border-color: #01998e !important;
        }
        /* Override Bootstrap's default blue for form controls */
        .form-select:active,
        .form-select:focus,
        .form-select:focus-visible {
            border-color: #01998e !important;
            box-shadow: 0 0 0 0.25rem rgba(1, 153, 142, 0.25) !important;
        }
        /* Override any blue colors in form controls */
        * {
            --bs-primary: #01998e !important;
            --bs-primary-rgb: 1, 153, 142 !important;
        }
        .btn-primary:hover {
            background-color: #017a70 !important;
            border-color: #017a70 !important;
        }
        .btn-outline-primary {
            color: #01998e !important;
            border-color: #01998e !important;
        }
        .btn-outline-primary:hover {
            background-color: #01998e !important;
            border-color: #01998e !important;
            color: white !important;
        }
        .text-primary {
            color: #01998e !important;
        }
        .spinner-border.text-primary {
            color: #01998e !important;
        }
        .alert-primary {
            background-color: #e6f7f6;
            border-color: #01998e;
            color: #017a70;
        }
        .bg-primary {
            background-color: #01998e !important;
        }
        .progress-bar {
            background-color: #01998e !important;
        }
        /* Dropdown/Select option highlighting - change from blue to green */
        /* Note: Browser support for styling <option> elements is limited, but we try our best */
        select.form-select {
            background-color: white !important;
        }
        select.form-select:focus {
            border-color: #01998e !important;
            box-shadow: 0 0 0 0.25rem rgba(1, 153, 142, 0.25) !important;
            outline: none !important;
        }
        /* For dropdown options list (when dropdown is open) */
        select.form-select option {
            background-color: white !important;
            color: #333 !important;
        }
        select.form-select option:checked,
        select.form-select option[selected],
        select.form-select option:focus {
            background: #01998e !important;
            background-color: #01998e !important;
            color: white !important;
        }
        select.form-select option:hover {
            background: #01b8aa !important;
            background-color: #01b8aa !important;
            color: white !important;
        }
        /* Browser-specific overrides for selection color */
        select.form-select::-ms-value {
            background-color: #01998e !important;
            color: white !important;
        }
        select.form-select::-webkit-select-value {
            background-color: #01998e !important;
            color: white !important;
        }
        /* Override Bootstrap's default blue focus color */
        select.form-select:focus:not(:disabled):not([readonly]) {
            border-color: #01998e !important;
            box-shadow: 0 0 0 0.25rem rgba(1, 153, 142, 0.25) !important;
        }
        .upload-area.border-2 {
            border-width: 2px !important;
        }
        #uploadLoading {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Dropdown arrow visibility */
        .dropdown-toggle::after {
            display: inline-block;
            margin-left: 0.255em;
            vertical-align: 0.255em;
            content: "";
            border-top: 0.3em solid;
            border-right: 0.3em solid transparent;
            border-bottom: 0;
            border-left: 0.3em solid transparent;
        }
        .caret {
            display: inline-block;
            width: 0;
            height: 0;
            margin-left: 2px;
            vertical-align: middle;
            border-top: 4px solid;
            border-right: 4px solid transparent;
            border-left: 4px solid transparent;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="{{ url_for('static', filename='customcolor_logo_transparent_background.jpeg') }}" alt="RFMS Logo">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item me-3">
                        <a class="nav-link" href="/receive-stock">
                            <i class="fas fa-box"></i> Receive Stock
                        </a>
                    </li>
                    <li class="nav-item me-3">
                        <a class="nav-link" href="/installer-photos">
                            <i class="fas fa-camera"></i> Get Pics
                        </a>
                    </li>
                    <li class="nav-item me-3">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <span class="navbar-text me-3">
                        <i class="fas fa-circle rfms-offline" id="rfms-status"></i>
                        <span id="rfms-status-text">RFMS Offline</span>
                    </span>
                    <button onclick="location.reload();" class="btn btn-sm btn-outline-light" title="Refresh Page">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message|safe }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // RFMS Status Check
        function checkRFMSStatus() {
            console.log('Checking RFMS status...');
            const statusIcon = document.getElementById('rfms-status');
            const statusText = document.getElementById('rfms-status-text');
            
            if (!statusIcon || !statusText) {
                console.error('RFMS status elements not found!');
                return;
            }
            
            fetch('/api/rfms-status')
                .then(response => response.json())
                .then(data => {
                    console.log('RFMS API Response:', data);
                    
                    if (data.online) {
                        // Remove offline class and add online class
                        statusIcon.classList.remove('rfms-offline');
                        statusIcon.classList.add('rfms-online');
                        statusText.textContent = 'RFMS Online';
                        statusText.title = data.message || 'RFMS is connected';
                        console.log('✅ RFMS Status: Online - Icon should be green');
                    } else {
                        // Remove online class and add offline class
                        statusIcon.classList.remove('rfms-online');
                        statusIcon.classList.add('rfms-offline');
                        
                        if (data.configured === false) {
                            statusText.textContent = 'RFMS Not Configured';
                            statusText.title = 'RFMS credentials not set up. Contact administrator.';
                        } else {
                            statusText.textContent = 'RFMS Offline';
                            statusText.title = data.message || 'RFMS connection failed';
                        }
                        console.log('❌ RFMS Status: Offline - Icon should be red');
                    }
                })
                .catch(error => {
                    console.error('Error checking RFMS status:', error);
                    statusIcon.classList.remove('rfms-online');
                    statusIcon.classList.add('rfms-offline');
                    statusText.textContent = 'RFMS Offline';
                    statusText.title = 'Failed to check RFMS status';
                });
        }
        
        // Multiple ways to ensure RFMS status check runs
        function initializeRFMSStatus() {
            console.log('Initializing RFMS status check...');
            setTimeout(checkRFMSStatus, 100);
            // Reduced frequency: check every 5 minutes instead of 30 seconds to reduce server load
            setInterval(checkRFMSStatus, 300000); // 5 minutes = 300000ms
        }
        
        // Try multiple event listeners to ensure it works
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeRFMSStatus);
        } else {
            // Document already loaded
            initializeRFMSStatus();
        }
        
        // Also check when page becomes visible (for navigation)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('Page became visible, checking RFMS status...');
                setTimeout(checkRFMSStatus, 100);
            }
        });
        
        // Additional check when window loads completely
        window.addEventListener('load', function() {
            console.log('Window loaded, checking RFMS status...');
            setTimeout(checkRFMSStatus, 200);
        });
        
        // Force check after a longer delay (for slow loading pages)
        setTimeout(function() {
            console.log('Delayed RFMS status check...');
            checkRFMSStatus();
        }, 1000);
        
        // Make checkRFMSStatus globally available
        window.checkRFMSStatus = checkRFMSStatus;
        
        // Also try to run immediately (for pages that load quickly)
        try {
            checkRFMSStatus();
        } catch (e) {
            console.log('Initial check failed, will retry:', e);
        }
        
        // Real-time uppercase conversion for all text inputs
        // Use a data attribute to track elements currently being converted to prevent infinite loops
        const CONVERTING_ATTR = 'data-uppercase-converting';
        
        function convertToUppercase(element) {
            if (!element) return;
            
            // Prevent infinite loops - if element is already being converted, skip
            if (element.getAttribute(CONVERTING_ATTR) === 'true') {
                return;
            }
            
            const tagName = element.tagName;
            const inputType = element.type || '';
            
            // Skip if element is disabled or readonly
            if (element.disabled || element.readOnly) {
                return;
            }
            
            // Check if this is a text input or textarea
            // Exclude email inputs - email addresses should preserve case
            const isTextInput = tagName === 'INPUT' && 
                (inputType === 'text' || inputType === 'search' || inputType === 'tel' || inputType === '');
            const isTextarea = tagName === 'TEXTAREA';
            
            if (isTextInput || isTextarea) {
                const cursorPos = element.selectionStart;
                const selectionEnd = element.selectionEnd;
                const originalValue = element.value;
                const newValue = originalValue.toUpperCase();
                
                // Only convert if value actually changed
                if (originalValue !== newValue) {
                    // Mark element as being converted to prevent recursive calls
                    element.setAttribute(CONVERTING_ATTR, 'true');
                    
                    // Use a microtask to batch DOM updates and prevent event loops
                    Promise.resolve().then(function() {
                        try {
                            element.value = newValue;
                            // Restore cursor/selection position
                            const newCursorPos = Math.min(cursorPos, newValue.length);
                            const newSelectionEnd = Math.min(selectionEnd, newValue.length);
                            element.setSelectionRange(newCursorPos, newSelectionEnd);
                        } finally {
                            // Remove flag after a short delay to allow events to settle
                            setTimeout(function() {
                                element.removeAttribute(CONVERTING_ATTR);
                            }, 50);
                        }
                    });
                }
            }
        }
        
        // Real-time uppercase on keypress (most immediate)
        document.addEventListener('keypress', function(e) {
            // Only convert on actual character keys, not special keys
            if (e.key && e.key.length === 1) {
                convertToUppercase(e.target);
            }
        }, true); // Use capture phase for earlier handling
        
        // Real-time uppercase on input (handles typing, pasting, etc.)
        document.addEventListener('input', function(e) {
            convertToUppercase(e.target);
        }, true);
        
        // Handle paste events
        document.addEventListener('paste', function(e) {
            const target = e.target;
            setTimeout(function() {
                convertToUppercase(target);
            }, 0);
        }, true);
        
        // Handle autocomplete and other programmatic changes
        document.addEventListener('change', function(e) {
            convertToUppercase(e.target);
        }, true);
        
        // Convert existing values on page load
        function convertExistingInputs() {
            // Exclude email inputs - email addresses should preserve case
            const textInputs = document.querySelectorAll('input[type="text"], input[type="search"], input[type="tel"], input:not([type]), textarea');
            textInputs.forEach(function(input) {
                if (input.value) {
                    convertToUppercase(input);
                }
            });
        }
        
        // Run immediately if DOM is already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', convertExistingInputs);
        } else {
            convertExistingInputs();
        }
        
        // Also handle dynamically added inputs using MutationObserver
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) { // Element node
                        // Check if the added node is an input/textarea
                        if (node.tagName === 'INPUT' || node.tagName === 'TEXTAREA') {
                            convertToUppercase(node);
                            // Also add event listeners to the new input
                            node.addEventListener('keypress', function(e) {
                                convertToUppercase(e.target);
                            });
                            node.addEventListener('input', function(e) {
                                convertToUppercase(e.target);
                            });
                        }
                        // Check for inputs/textareas within the added node
                        // Exclude email inputs - email addresses should preserve case
                        const inputs = node.querySelectorAll && node.querySelectorAll('input[type="text"], input[type="search"], input[type="tel"], input:not([type]), textarea');
                        if (inputs) {
                            inputs.forEach(function(input) {
                                convertToUppercase(input);
                                input.addEventListener('keypress', function(e) {
                                    convertToUppercase(e.target);
                                });
                                input.addEventListener('input', function(e) {
                                    convertToUppercase(e.target);
                                });
                            });
                        }
                    }
                });
            });
        });
        
        // Start observing the document body for dynamically added elements
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html> 