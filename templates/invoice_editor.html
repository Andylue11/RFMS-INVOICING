
New
+161
-0

{% extends 'base_portal.html' %}
{% block title %}Invoice {{ invoice.invoice_number }}{% endblock %}
{% block content %}
<style>
    /* Force uppercase for invoice line descriptions only */
    input[name="description[]"],
    textarea[name="notes"] {
        text-transform: uppercase;
    }
    /* Custom checkbox styling - green when checked */
    #no_gst:checked {
        background-color: #01998e !important;
        border-color: #01998e !important;
    }
    #no_gst:focus {
        border-color: #01998e !important;
        box-shadow: 0 0 0 0.25rem rgba(1, 153, 142, 0.25) !important;
    }
</style>
<div class="container py-4">
    <!-- Invoice/Order/Job, Sold To, and Ship To Information in one row -->
    <div class="row mb-3 align-items-start">
        <div class="col-md-4">
            <div class="d-flex align-items-center gap-2 mb-2">
                <label for="invoice_number" class="form-label mb-0" style="font-weight: bold;">Invoice Number:</label>
                <div class="input-group" style="width: auto; min-width: 200px;">
                    <input type="text" 
                           id="invoice_number" 
                           name="invoice_number" 
                           class="form-control" 
                           value="{{ invoice.invoice_number }}" 
                           required>
                    <span class="input-group-text" style="background-color: #f8f9fa;">
                        <i class="fa fa-edit text-primary" title="Editable"></i>
                    </span>
                </div>
            </div>
            <p class="text-muted mb-0">Order {{ work_order.order_number }} • Job {{ work_order.job_number or 'N/A' }}</p>
        </div>
        <div class="col-md-4">
            {% if sold_to_details %}
            <div class="mb-2">
                <div class="fw-semibold small text-muted mb-1">SOLD TO:</div>
                <div class="fw-semibold">{{ sold_to_details.name }}</div>
            </div>
            {% endif %}
        </div>
        <div class="col-md-4">
            {% if ship_to_details %}
            <div class="mb-2">
                <div class="fw-semibold small text-muted mb-1">SHIP TO:</div>
                <div class="fw-semibold mb-1">{{ ship_to_details.name }}</div>
                <div class="text-muted small" style="line-height: 1.4;">
                    <div>{{ ship_to_details.street_address }}</div>
                    <div>{{ ship_to_details.suburb }}</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <h5 class="card-title mb-0">Line Items</h5>
                    <small class="text-muted">Pre-loaded from RFMS where available. Add or edit to suit.</small>
                </div>
                <button class="btn btn-outline-primary btn-sm" type="button" id="add-line">Add line</button>
            </div>
            <form method="post" enctype="multipart/form-data">
                <div class="table-responsive mb-3">
                    <table class="table align-middle" id="lines-table">
                        <thead>
                            <tr>
                                <th style="width: 100px;">Service Code</th>
                                <th style="padding-left: 5px;">Description</th>
                                <th style="width: 120px; padding-left: 50px;">Quantity</th>
                                <th style="width: 130px; text-align: center; padding-left: 50px;">Unit price</th>
                                <th style="width: 140px; text-align: right;">Line total</th>
                                <th style="width: 40px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for line in invoice.lines %}
                            <tr>
                                <td>
                                    <input type="hidden" name="line_id[]" value="{{ line.id }}">
                                    {% if line.work_order_line and line.work_order_line.source_line_number %}
                                        {% set source_num = line.work_order_line.source_line_number %}
                                        {% if roll_item_numbers_map.get(source_num) or roll_item_numbers_map.get(source_num|string) %}
                                            <span class="text-muted small">{{ roll_item_numbers_map.get(source_num) or roll_item_numbers_map.get(source_num|string) }}</span>
                                        {% else %}
                                            <span class="text-muted small">-</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                                <td style="padding-left: 5px;">
                                    <input type="text" class="form-control" name="description[]" value="{{ line.description }}" required>
                                </td>
                                <td style="padding-left: 50px;"><input type="number" step="0.01" min="0" class="form-control" name="quantity[]" value="{{ '%.2f'|format(line.quantity) }}" required></td>
                                <td style="text-align: center; padding-left: 50px;"><input type="number" step="0.01" min="0" class="form-control" name="unit_price[]" value="{{ '%.2f'|format(line.unit_price) }}" required style="text-align: center;"></td>
                                <td class="fw-semibold line-total text-end">{{ '%.2f'|format(line.quantity * line.unit_price) }}</td>
                                <td class="text-center" style="padding: 0.25rem;">
                                    <button type="button" class="btn btn-link text-danger p-0 remove-line" style="font-size: 0.875rem;"><i class="fa fa-trash"></i></button>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if not invoice.lines %}
                            <tr>
                                <td>
                                    <input type="hidden" name="line_id[]" value="">
                                    <span class="text-muted small">-</span>
                                </td>
                                <td style="padding-left: 5px;">
                                    <input type="text" class="form-control" name="description[]" placeholder="Description" required>
                                </td>
                                <td style="padding-left: 50px;"><input type="number" step="0.01" min="0" class="form-control" name="quantity[]" value="0" required></td>
                                <td style="text-align: center; padding-left: 50px;"><input type="number" step="0.01" min="0" class="form-control" name="unit_price[]" value="0" required style="text-align: center;"></td>
                                <td class="fw-semibold line-total text-end">0.00</td>
                                <td class="text-center" style="padding: 0.25rem;">
                                    <button type="button" class="btn btn-link text-danger p-0 remove-line" style="font-size: 0.875rem;"><i class="fa fa-trash"></i></button>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="row mb-3">
                    <div class="col-lg-6">
                        <label class="form-label">Notes to A to Z Flooring</label>
                        <textarea class="form-control" rows="3" name="notes">{{ invoice.notes or '' }}</textarea>
                    </div>
                    <div class="col-lg-6">
                        <div style="display: flex; justify-content: flex-start; margin-left: 40px;">
                            <dl class="mb-0" style="width: auto;">
                                <div class="d-flex mb-1">
                                    <dt class="mb-0" style="width: auto; margin-right: auto;">Subtotal</dt>
                                    <dd class="mb-0 text-end" id="subtotal" style="width: 140px; text-align: right; margin-left: auto;">0.00</dd>
                                </div>
                                <div class="d-flex mb-1 tax-row" id="tax-label" style="visibility: visible;">
                                    <dt class="mb-0" style="width: auto; margin-right: auto; display: flex; align-items: center; gap: 0.5rem; flex-wrap: nowrap;">
                                        <span>GST (10%)</span>
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="no_gst" 
                                               name="no_gst" 
                                               value="1"
                                               style="margin: 0; width: 1.25rem; height: 1.25rem; border: 2px solid #333; cursor: pointer; flex-shrink: 0;"
                                               {% if invoice.tax_amount == 0 and invoice.subtotal > 0 %}checked{% endif %}>
                                        <label for="no_gst" style="margin: 0; font-size: 0.9rem; cursor: pointer; font-weight: normal; white-space: nowrap;">
                                            Not claiming GST
                                        </label>
                                    </dt>
                                    <dd class="mb-0 text-end tax-row" id="tax" style="width: 140px; text-align: right; margin-left: auto; min-width: 140px;">0.00</dd>
                                </div>
                                <div class="d-flex mb-0">
                                    <dt class="mb-0 fw-bold" style="width: auto; margin-right: auto;">Total</dt>
                                    <dd class="mb-0 text-end fw-bold" id="total" style="width: 140px; text-align: right; margin-left: auto;">0.00</dd>
                                </div>
                            </dl>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <label class="form-label mb-0">Upload photos or documents</label>
                        <div class="d-flex gap-2">
                            <button type="submit" name="action" value="save" class="btn btn-outline-secondary btn-sm">Save draft</button>
                            <button type="submit" name="action" value="submit" class="btn btn-primary btn-sm" id="submitInvoiceBtn" {% if not existing_installer_photos %}disabled title="Please upload at least one installer photo before submitting"{% endif %}>Submit invoice</button>
                        </div>
                    </div>
                    <input type="file" name="attachments" multiple class="form-control" id="photoUploadInput" accept="image/*,application/pdf">
                    <div class="small text-muted mt-1" id="photoStatusMessage">
                        {% if existing_installer_photos %}
                            <span class="text-success">✓ Installer photos available</span>
                        {% else %}
                            <span class="text-warning">⚠ Please upload at least one installer photo to submit</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if invoice.status == 'submitted' %}
                <div class="mb-3">
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('portal.export_invoice_xero', invoice_id=invoice.id) }}" class="btn btn-outline-success btn-sm">
                            <i class="fa fa-download me-2"></i>Export to Xero (CSV)
                        </a>
                        <a href="{{ url_for('portal.export_invoice_pdf', invoice_id=invoice.id) }}" class="btn btn-outline-primary btn-sm">
                            <i class="fa fa-file-pdf me-2"></i>Download PDF
                        </a>
                    </div>
                </div>
                {% endif %}
                
                {% if existing_installer_photos %}
                <div class="mb-3">
                    <label class="form-label text-info">
                        <i class="fa fa-info-circle me-2"></i>Existing Installer Photos Already Uploaded to RFMS
                    </label>
                    <div class="alert alert-info mb-0">
                        <p class="mb-2 small">The following photos have already been uploaded to this order. You don't need to upload them again:</p>
                        <div class="row g-2">
                            {% for photo in existing_installer_photos %}
                            <div class="col-lg-3 col-md-3 col-sm-6 col-6">
                                <div class="card border-info h-100">
                                    <div class="card-body p-2 text-center">
                                        {% set photo_id = photo.get('id') or photo.get('attachmentId') or photo.get('attachment_id') %}
                                        {% set description = photo.get('description') or photo.get('name') or photo.get('title') or 'Photo' %}
                                        {% set file_ext = (photo.get('fileExtension') or photo.get('file_type') or '').lower() %}
                                        {% set is_image = file_ext in ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'heic', 'heif'] %}
                                        
                                        {% if is_image %}
                                        {% if photo.get('fileData') %}
                                        <img src="data:image/{{ file_ext or 'jpeg' }};base64,{{ photo.fileData }}" 
                                             class="img-thumbnail mb-1" 
                                             style="max-width: 100%; max-height: 150px; min-height: 150px; width: 100%; object-fit: cover; cursor: pointer;"
                                             alt="{{ description }}"
                                             onclick="window.open('data:image/{{ file_ext or 'jpeg' }};base64,{{ photo.fileData }}', '_blank')"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div style="display: none; min-height: 150px; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-image fa-3x text-muted"></i>
                                        </div>
                                        {% elif photo_id %}
                                        <img src="{{ url_for('portal.get_attachment_thumbnail', attachment_id=photo_id) }}" 
                                             class="img-thumbnail mb-1" 
                                             style="max-width: 100%; max-height: 150px; min-height: 150px; width: 100%; object-fit: cover; cursor: pointer;"
                                             alt="{{ description }}"
                                             onclick="window.open('{{ url_for('portal.get_attachment_file', attachment_id=photo_id) }}', '_blank')"
                                             onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <div style="display: none; min-height: 150px; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                            <i class="fas fa-image fa-3x text-muted mb-1"></i>
                                            <div class="small text-muted">Image</div>
                                        </div>
                                        {% else %}
                                        <div style="min-height: 150px; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-image fa-3x text-muted"></i>
                                        </div>
                                        {% endif %}
                                        {% else %}
                                        <div style="min-height: 150px; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-file fa-3x text-muted"></i>
                                        </div>
                                        {% endif %}
                                        <div class="small text-truncate mt-1" title="{{ description }}">
                                            {{ description[:30] }}{% if description|length > 30 %}...{% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>

<script>
    const linesTable = document.getElementById('lines-table').querySelector('tbody');
    const subtotalEl = document.getElementById('subtotal');
    const taxEl = document.getElementById('tax');
    const totalEl = document.getElementById('total');

    const noGstCheckbox = document.getElementById('no_gst');
    const taxLabel = document.getElementById('tax-label');
    const taxValue = document.getElementById('tax');
    
    function recalc() {
        // Calculate subtotal from all line totals (quantity × unit_price)
        let subtotal = 0;
        linesTable.querySelectorAll('tr').forEach((row) => {
            const qty = parseFloat(row.querySelector('input[name="quantity[]"]').value || '0');
            const unit = parseFloat(row.querySelector('input[name="unit_price[]"]').value || '0');
            const lineTotal = qty * unit;
            subtotal += lineTotal;
            // Update line total display (non-tax, non-GST)
            const lineTotalCell = row.querySelector('td.line-total');
            if (lineTotalCell) {
                lineTotalCell.innerText = lineTotal.toFixed(2);
            }
        });
        
        // Check if "Not claiming GST" is checked
        const noGst = noGstCheckbox && noGstCheckbox.checked;
        
        // Calculate tax amount (0 if not claiming GST, otherwise 10%)
        const tax = noGst ? 0 : subtotal * 0.10;
        const total = subtotal + tax;
        
        // Update display
        subtotalEl.innerText = subtotal.toFixed(2);
        taxEl.innerText = tax.toFixed(2);
        totalEl.innerText = total.toFixed(2);
        
        // Keep GST row visible at all times - just set tax to 0 when checkbox is checked
        // No need to hide/show the row anymore
    }
    
    // Recalculate when checkbox changes
    if (noGstCheckbox) {
        noGstCheckbox.addEventListener('change', recalc);
    }
    
    // Also allow clicking the label to toggle the checkbox
    const noGstLabel = document.querySelector('label[for="no_gst"]');
    if (noGstLabel) {
        noGstLabel.addEventListener('click', function(e) {
            // Let the default label behavior handle the checkbox toggle
            setTimeout(recalc, 0);
        });
    }
    
    // Calculate on page load
    recalc();

    function bindEvents(row) {
        row.querySelectorAll('input').forEach((input) => {
            input.addEventListener('input', recalc);
        });
        const removeBtn = row.querySelector('.remove-line');
        if (removeBtn) {
            removeBtn.addEventListener('click', () => {
                row.remove();
                recalc();
            });
        }
    }

    document.querySelectorAll('#lines-table tbody tr').forEach(bindEvents);

    document.getElementById('add-line').addEventListener('click', () => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="hidden" name="line_id[]" value="">
                <span class="text-muted small">-</span>
            </td>
            <td style="padding-left: 5px;">
                <input type="text" class="form-control" name="description[]" placeholder="Description" required>
            </td>
            <td style="padding-left: 50px;"><input type="number" step="0.01" min="0" class="form-control" name="quantity[]" value="0" required></td>
            <td style="text-align: center; padding-left: 50px;"><input type="number" step="0.01" min="0" class="form-control" name="unit_price[]" value="0" required style="text-align: center;"></td>
            <td class="fw-semibold line-total text-end">0.00</td>
            <td class="text-center" style="padding: 0.25rem;">
                <button type="button" class="btn btn-link text-danger p-0 remove-line" style="font-size: 0.875rem;"><i class="fa fa-trash"></i></button>
            </td>
        `;
        linesTable.appendChild(row);
        bindEvents(row);
        
        // Apply uppercase to the new description field
        const newDescInput = row.querySelector('input[name="description[]"]');
        if (newDescInput) {
            // Add event listeners for uppercase conversion
            newDescInput.addEventListener('keypress', function(e) {
                if (e.key && e.key.length === 1) {
                    convertToUppercase(e.target);
                }
            });
            newDescInput.addEventListener('input', function(e) {
                convertToUppercase(e.target);
            });
        }
        
        // Recalculate totals after adding line
        recalc();
    });
    
    // Force uppercase for invoice description fields and notes
    function convertToUppercase(element) {
        if (!element) return;
        
        // Only convert description inputs and notes textarea
        const isDescription = element.name === 'description[]';
        const isNotes = element.name === 'notes';
        
        if (!isDescription && !isNotes) return;
        
        // Skip if disabled or readonly
        if (element.disabled || element.readOnly) return;
        
        const cursorPos = element.selectionStart;
        const selectionEnd = element.selectionEnd;
        const originalValue = element.value;
        const newValue = originalValue.toUpperCase();
        
        // Only convert if value actually changed
        if (originalValue !== newValue) {
            element.value = newValue;
            // Restore cursor/selection position
            const newCursorPos = Math.min(cursorPos, newValue.length);
            const newSelectionEnd = Math.min(selectionEnd, newValue.length);
            if (element.setSelectionRange) {
                element.setSelectionRange(newCursorPos, newSelectionEnd);
            }
        }
    }
    
    // Apply uppercase on keypress for description fields
    document.addEventListener('keypress', function(e) {
        if (e.target.name === 'description[]' || e.target.name === 'notes') {
            if (e.key && e.key.length === 1) {
                convertToUppercase(e.target);
            }
        }
    }, true);
    
    // Apply uppercase on input (handles typing, pasting, etc.)
    document.addEventListener('input', function(e) {
        if (e.target.name === 'description[]' || e.target.name === 'notes') {
            convertToUppercase(e.target);
        }
    }, true);
    
    // Handle paste events
    document.addEventListener('paste', function(e) {
        if (e.target.name === 'description[]' || e.target.name === 'notes') {
            setTimeout(function() {
                convertToUppercase(e.target);
            }, 0);
        }
    }, true);
    
    // Convert existing values on page load
    function convertExistingInputs() {
        const descriptionInputs = document.querySelectorAll('input[name="description[]"], textarea[name="notes"]');
        descriptionInputs.forEach(function(input) {
            if (input.value) {
                convertToUppercase(input);
            }
        });
    }
    
    // Run immediately if DOM is already loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', convertExistingInputs);
    } else {
        convertExistingInputs();
    }
    
    // Handle photo upload validation for submit button
    const submitInvoiceBtn = document.getElementById('submitInvoiceBtn');
    const photoUploadInput = document.getElementById('photoUploadInput');
    const photoStatusMessage = document.getElementById('photoStatusMessage');
    const hasExistingPhotos = {{ 'true' if existing_installer_photos else 'false' }};
    
    function updateSubmitButtonState() {
        const hasNewPhotos = photoUploadInput && photoUploadInput.files && photoUploadInput.files.length > 0;
        const canSubmit = hasExistingPhotos || hasNewPhotos;
        
        if (submitInvoiceBtn) {
            submitInvoiceBtn.disabled = !canSubmit;
            if (canSubmit) {
                submitInvoiceBtn.title = '';
                submitInvoiceBtn.classList.remove('btn-secondary');
                submitInvoiceBtn.classList.add('btn-primary');
            } else {
                submitInvoiceBtn.title = 'Please upload at least one installer photo before submitting';
                submitInvoiceBtn.classList.remove('btn-primary');
                submitInvoiceBtn.classList.add('btn-secondary');
            }
        }
        
        if (photoStatusMessage) {
            if (canSubmit) {
                photoStatusMessage.innerHTML = '<span class="text-success">✓ Installer photos available</span>';
            } else {
                photoStatusMessage.innerHTML = '<span class="text-warning">⚠ Please upload at least one installer photo to submit</span>';
            }
        }
    }
    
    // Update on file selection
    if (photoUploadInput) {
        photoUploadInput.addEventListener('change', updateSubmitButtonState);
    }
    
    // Initialize state on page load
    updateSubmitButtonState();
</script>
{% endblock %}
templates/portal_dashboard.html
New

